<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>클래스어라운드 · 카카오톡 입장자 체크봇 (Sheets API)</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg:#fff; --card:#fff; --surface:#f8fafc; --line:#e5e7eb; --text:#0f172a; --muted:#64748b;
      --accent:#60a5fa; --accent-strong:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:12px; --ctl-h:42px; --gap:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px;position:relative}
    h1{font-size:22px;margin:0 0 8px}
    .sub{color:var(--muted);margin-bottom:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px}
    label{display:block;color:var(--muted);margin-bottom:6px}
    select, input[type=text], input[type=file]{
      width:100%; background:#fff; color:var(--text); border:1px solid var(--line);
      border-radius:var(--radius); padding:10px 12px; outline:none; height:var(--ctl-h);
    }
    .btn{
      appearance:none; border:1px solid var(--line); background:#fff; color:var(--text);
      padding:10px 14px; border-radius:var(--radius); cursor:pointer; transition:all .15s ease;
      height:var(--ctl-h); display:inline-flex; align-items:center; justify-content:center;
    }
    .btn:hover{border-color:var(--accent-strong);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
    .btn.acc{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.acc:hover{background:var(--accent-strong);border-color:var(--accent-strong)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hint{color:#64748b;font-size:12px}
    .err{color:#ef4444;font-family:ui-monospace,monospace;white-space:pre-wrap}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);background:#fff}
    .pill.ok{border-color:rgba(34,197,94,.25);color:var(--ok)}
    .pill.warn{border-color:rgba(245,158,11,.25);color:var(--warn)}
    .pill.bad{border-color:rgba(239,68,68,.25);color:var(--bad)}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);overflow:auto;background:#fff;border-radius:12px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{color:#0f172a;font-weight:600;background:#f1f5f9;position:sticky;top:0}
    .controls-grid{display:grid;gap:var(--gap);align-items:end}
    @media(min-width:1000px){ .controls-grid{grid-template-columns:1.2fr 1.1fr 1fr} }
    @media(min-width:640px) and (max-width:999px){ .controls-grid{grid-template-columns:1fr 1fr} }
    .gear-btn{position:fixed;top:16px;right:16px;z-index:50;background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;cursor:pointer}
    .admin-overlay{position:fixed;inset:0;background:rgba(15,23,42,.28);backdrop-filter:saturate(140%) blur(2px);
      visibility:hidden; opacity:0; pointer-events:none; transition:.15s; z-index:60;}
    .admin-overlay.open{visibility:visible; opacity:1; pointer-events:auto;}
    .admin-drawer{position:fixed;top:0;right:0;height:100%;width:520px;max-width:92vw;background:#fff;border-left:1px solid var(--line);
      box-shadow:-8px 0 24px rgba(0,0,0,.08);padding:16px 16px 24px;display:flex;flex-direction:column;gap:12px;z-index:70;
      transform:translateX(12px); opacity:0; pointer-events:none; transition:transform .15s, opacity .15s}
    .admin-drawer.open{transform:translateX(0); opacity:1; pointer-events:auto;}
    .admin-head{display:flex;align-items:center;justify-content:space-between}
    .x-btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer}
  </style>
</head>
<body>
  <button id="settingsBtn" class="gear-btn" title="설정" type="button" aria-label="관리자 설정 열기">⚙</button>

  <div class="wrap">
    <h1>클래스어라운드 카카오톡 입장자 체크봇</h1>
    <div class="sub">
      1) <b>Google 로그인</b> → 2) <b>관리자(⚙)</b>에서 <b>스프레드시트 링크 + 읽을 열</b> 등록 → 3) 메인에서 <b>읽기 시트/공유 시트</b> 선택 후 실행.<br>
      공유 시트는 <b>D=이름</b>, <b>E=전화</b>, <b>S=상태</b> 기준. 대상은 <b>I열이 ‘결제 완료’</b>로 판정된 행만.
    </div>

    <div class="card">
      <div class="row">
        <button id="gsLoginBtn" class="btn acc" type="button">Google 로그인</button>
        <button id="gsLogoutBtn" class="btn" type="button">로그아웃</button>
        <span id="authState" class="hint">미로그인</span>
      </div>
      <div id="authErr" class="err" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <div class="controls-grid">
        <div>
          <label>카카오톡 대화 <span class="hint">.txt</span></label>
          <input id="chatFile" type="file" accept=".txt" />
          <div class="hint">예: “… 권지혁/3788님이 입장하셨습니다.”</div>
        </div>
        <div>
          <label>로스터 소스 (스프레드시트)</label>
          <div class="row">
            <select id="sheetPackSelect" style="min-width:220px"></select>
            <button id="refreshMeta" class="btn" type="button">시트 목록 새로고침</button>
          </div>
          <div class="hint">읽기 시작 행: <b id="readStartHint">2</b> · 읽을 열: <b id="readColHint">-</b> · 공유 시작 행: <b id="writeStartHint">2</b></div>
        </div>
        <div>
          <label>읽기 시트 / 공유 시트</label>
          <div class="row">
            <select id="readSheetSelect" style="min-width:180px"></select>
            <select id="writeSheetSelect" style="min-width:180px"></select>
          </div>
          <div class="hint">동명이인은 전화 <b>끝 4자리</b>로 재매칭, 결과는 <b>S열</b>에 “입장”만 기록(미입장은 빈칸).</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="runBtn" class="btn acc" type="button">실행</button>
        <button id="demoBtn" class="btn" type="button">데모</button>
        <span id="pills" class="row"></span>
      </div>
      <div id="err" class="err" style="margin-top:8px"></div>
    </div>

    <div id="results" style="display:grid;gap:16px"></div>
  </div>

  <div id="adminOverlay" class="admin-overlay" aria-hidden="true"></div>
  <aside id="adminDrawer" class="admin-drawer" aria-hidden="true">
    <div class="admin-head">
      <h3 style="margin:0">관리자 설정</h3>
      <button id="closeAdmin" class="x-btn" type="button">닫기</button>
    </div>

    <div class="card" style="margin:0">
      <h4 style="margin:0 0 8px">스프레드시트 연결 추가</h4>
      <label>표시 이름(선택)</label>
      <input id="admLabel" type="text" placeholder="예: 4기 운영 시트" />
      <label style="margin-top:10px">스프레드시트 링크(URL)</label>
      <input id="admUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/..." />
      <label style="margin-top:10px">읽을 열(A~) <span class="hint">명단 열(예: C)</span></label>
      <input id="admReadCol" type="text" value="C" />
      <div class="row" style="margin-top:10px">
        <button id="admAdd" class="btn" type="button">연결 추가</button>
        <button id="admClearAll" class="btn" type="button">전체 삭제</button>
      </div>
      <div id="admErr" class="err" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 8px">등록된 스프레드시트</h4>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr><th style="background:#f1f5f9">라벨</th><th style="background:#f1f5f9">시트수</th><th style="background:#f1f5f9">읽을 열</th><th style="background:#f1f5f9">작업</th></tr></thead>
        <tbody id="admList"><tr><td colspan="4" style="color:#64748b">없음</td></tr></tbody>
      </table>
      <div class="hint" id="admMeta" style="margin-top:6px"></div>
    </div>
  </aside>

<script>
/* ===== 전역 오류를 UI에 표시 ===== */
(function(){
  const pushErr = (msg, src, line, col, err)=> {
    const el = document.getElementById('err');
    const details = (err && err.stack) ? ('\\n' + err.stack) : '';
    if (el) el.textContent = '오류: ' + msg + (src?`\\n${src}:${line}:${col}`:'') + details;
  };
  window.addEventListener('error', e=>{ pushErr(e.message, e.filename, e.lineno, e.colno, e.error); });
  window.addEventListener('unhandledrejection', e=>{ const r = e.reason || {}; pushErr(r.message || String(r), '', 0, 0, r); });
})();

/* ===== 설정 ===== */
const READ_START_ROW  = 2;
const WRITE_START_ROW = 2;
const CLIENT_ID = "18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com";

/* ===== 유틸 ===== */
const $$ = (id)=>document.getElementById(id);
const txt = (id, v)=>{ const el=$$(id); if(el) el.textContent=v||""; };
const val = (id)=>{ const el=$$(id); return el?el.value:""; };
function on(id, event, handler){ const el=$$(id); if(!el){ console.warn("[bind skipped] #"+id); return; } el.addEventListener(event, e=>{ try{ handler(e); }catch(err){ console.error(err); }}); }
function delegateClick(id, handler){ document.addEventListener('click', e=>{ const t=e.target.closest('#'+id); if(t){ try{ handler(e);}catch(err){console.error(err);} } }); }
function show(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
function hide(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }
function last4Digits(s){ const d=String(s||'').replace(/[^\d]/g,''); return d.slice(-4); }
function normalizeName(n){
  let s = String(n||'').trim();
  // 끝의 괄호/태그 제거: (..), […], {…}, （…）, 【…】
  s = s.replace(/[\s]*[\(\[\{（【][^)\]\}）】]*[\)\]\}）】]\s*$/,'');
  // 끝 구분자 제거
  s = s.replace(/[/_\-\s]+$/,'');
  // 공백 정리
  s = s.replace(/\s+/g,' ');
  return s;
}
function isPaid(v){
  const s = String(v||'').trim().toLowerCase();
  if(!s) return false;
  const ns = s.replace(/\s/g,'');
  // 부정 패턴 우선
  if(/미결제|미완료|취소|환불/.test(ns)) return false;
  if(/\b(no|false|x)\b/.test(s)) return false;
  // 긍정 패턴
  if(ns==='결제완료') return true;
  if(/결제/.test(s) && /(완료|확인|됨|ok)/.test(s)) return true;
  if(/입금|납부|paid|완료|확인|ok|done|true|yes|\by\b|\bo\b|✓|✔|✅/.test(s)) return true;
  return false;
}

/* ===== OAuth ===== */
let accessToken=null, tokenClient=null;
function initAuth(){
  try{
    if(!window.google?.accounts?.oauth2){ txt('authErr','GIS 로드 실패'); return; }
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/spreadsheets',
      prompt: '',
      callback: (res)=>{ accessToken = res.access_token; txt("authState",'로그인 완료'); txt("authErr",''); },
      error_callback: (err)=>{ txt("authErr",'OAuth 오류: '+(err?.error||err?.type||JSON.stringify(err))); }
    });
  }catch(e){ txt('authErr','OAuth 초기화 오류'); console.error(e); }
}
function requestAccess(){ if(!tokenClient){ txt('authErr','OAuth 초기화 실패'); return; } tokenClient.requestAccessToken({prompt:'consent'}); }
function revokeAccess(){ if(accessToken){ google.accounts.oauth2.revoke(accessToken, ()=>{ accessToken=null; txt("authState",'미로그인'); }); } }
function requireAuth(){ if(!accessToken) throw new Error('먼저 Google 로그인하세요.'); }

/* ===== Sheets REST ===== */
async function gFetch(url, init){
  requireAuth();
  const res = await fetch(url, { ...(init||{}), headers: { ...(init&&init.headers||{}), Authorization:'Bearer '+accessToken, 'Content-Type':'application/json' }});
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}
async function listSheets(spreadsheetId){
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets(properties(title))`;
  const data = await gFetch(url);
  return (data.sheets||[]).map(s=>s.properties.title);
}
async function getRange(spreadsheetId, rangeA1){
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}/values/${encodeURIComponent(rangeA1)}`;
  return await gFetch(url);
}
async function batchUpdateValues(spreadsheetId, dataRanges){
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}/values:batchUpdate`;
  return await gFetch(url, { method:'POST', body: JSON.stringify({ valueInputOption:'USER_ENTERED', data: dataRanges })});
}

/* ===== 관리자 저장 ===== */
const PACKS_KEY='ca_gsapi_sources_v9';
const loadPacks=()=>{ try{return JSON.parse(localStorage.getItem(PACKS_KEY)||'[]');}catch(e){return [];} };
const savePacks=(ps)=> localStorage.setItem(PACKS_KEY, JSON.stringify(ps));
const addPack=(p)=>{ const a=loadPacks(); a.push(p); savePacks(a); };
const removePack=(id)=> savePacks(loadPacks().filter(p=>p.id!==id));
const clearPacks=()=> localStorage.removeItem(PACKS_KEY);

async function admAdd(){
  try{
    txt('admErr','');
    const label = (val("admLabel").trim() || "스프레드시트");
    const urlOrId = val("admUrl").trim();
    const m = urlOrId.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    const sheetId = m? m[1] : urlOrId;
    const readCol = (val("admReadCol").trim() || 'C').toUpperCase();
    if(!sheetId) throw new Error('스프레드시트 링크/ID를 입력하세요.');
    const titles = await listSheets(sheetId);
    const pack = { id:`${Date.now()}_${Math.random().toString(36).slice(2,7)}`, label, sheetId, readCol, sheets: titles };
    addPack(pack);
    ['admLabel','admUrl'].forEach(id=>{ const el=$$(id); if(el) el.value=''; });
    const rc=$$('admReadCol'); if(rc) rc.value='C';
    renderAdmList(); populatePacks(); alert('연결 완료! 메인에서 선택하세요.');
  }catch(e){ txt('admErr', e.message); }
}
function renderAdmList(){
  const list=loadPacks(); const tb=$$("admList"); if(!tb) return; tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="4" style="color:#64748b">없음</td></tr>'; txt("admMeta",''); return; }
  list.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.label}</td><td>${p.sheets?.length||0}</td><td>${p.readCol}</td><td><button class="btn" data-del="${p.id}" type="button">삭제</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-del]').forEach(b=> b.addEventListener('click', e=>{ removePack(e.target.getAttribute('data-del')); renderAdmList(); populatePacks(); }));
  txt("admMeta", `총 ${list.length}개 연결 · ${new Date().toLocaleString()}`);
}

/* ===== 메인: 시트 선택 ===== */
function populatePacks(){
  const packs=loadPacks(); const sel=$$("sheetPackSelect"); if(!sel) return; sel.innerHTML='';
  const readSel=$$("readSheetSelect"), writeSel=$$("writeSheetSelect");
  if(!packs.length){
    sel.appendChild(new Option('(관리자에서 스프레드시트 연결)',''));
    txt("readColHint",'-'); txt("readStartHint",READ_START_ROW); txt("writeStartHint",WRITE_START_ROW);
    if(readSel) readSel.innerHTML=''; if(writeSel) writeSel.innerHTML='';
    return;
  }
  sel.appendChild(new Option('스프레드시트 선택',''));
  packs.forEach(p=> sel.appendChild(new Option(p.label, p.id)));
  const prev=sessionStorage.getItem('ca_prev_pack'); if(prev){ const o=[...sel.options].find(x=>x.value===prev); if(o) o.selected=true; }
  onPackChanged();
}
async function refreshMeta(){
  try{
    const sel=$$("sheetPackSelect"); if(!sel) return;
    const id=sel.value; if(!id) return;
    const packs=loadPacks(); const idx=packs.findIndex(p=>p.id===id); if(idx<0) return;
    const titles = await listSheets(packs[idx].sheetId);
    packs[idx].sheets = titles; savePacks(packs); onPackChanged();
  }catch(e){ txt('err','시트 목록 갱신 실패: '+e.message); }
}
function onPackChanged(){
  const sel=$$("sheetPackSelect"); if(!sel) return;
  const id=sel.value; sessionStorage.setItem('ca_prev_pack', id||'');
  const packs=loadPacks(); const p=packs.find(x=>x.id===id);
  const readSel=$$("readSheetSelect"), writeSel=$$("writeSheetSelect");
  if(readSel) readSel.innerHTML=''; if(writeSel) writeSel.innerHTML='';
  if(!p){ txt("readColHint",'-'); txt("readStartHint",READ_START_ROW); txt("writeStartHint",WRITE_START_ROW); return; }
  txt("readColHint",p.readCol); txt("readStartHint",READ_START_ROW); txt("writeStartHint",WRITE_START_ROW);
  if(readSel) readSel.appendChild(new Option('읽기 시트 선택',''));
  if(writeSel) writeSel.appendChild(new Option('공유 시트 선택',''));
  (p.sheets||[]).forEach(t=>{ if(readSel) readSel.appendChild(new Option(t,t)); if(writeSel) writeSel.appendChild(new Option(t,t)); });
}

/* ===== 카톡 파싱 ===== */
const JOIN_PAT  = /(.*?)님이\s*(입장하셨습니다|들어왔습니다|입장했습니다|들어오셨습니다)[\s\.\!]*$/;
const LEAVE_PAT = /(.*?)님이\s*(퇴장하셨습니다|나갔습니다|퇴장했습니다|나가셨습니다)[\s\.\!]*$/;

function splitNickname(nick){
  const raw = String(nick||'').trim();
  if(!raw) return null;
  // 이름: 첫 숫자 전까지, 끝 구분자(/ _ - 공백) 제거 → 정규화
  const firstDigitIdx = raw.search(/\d/);
  let namePart = firstDigitIdx >= 0 ? raw.slice(0, firstDigitIdx) : raw;
  let name = namePart.replace(/[/_\-\s]+$/,'');
  name = normalizeName(name);
  if(!name) return {name: raw, digits: null};
  // 번호: 특수기호 제거 → 숫자만 → 끝 4
  const digitsAll = raw.replace(/[^\d]/g,'');
  const digits = digitsAll.length >= 4 ? digitsAll.slice(-4) : null;
  return { name, digits };
}
async function readText(file){ return await file.text(); }
function parseChat(text){
  const lines=text.split(/\r?\n/);
  const events=[]; let joinedCount=0,leftCount=0;
  for(const raw of lines){
    const line=raw.trim(); if(!line) continue;
    let m=line.match(JOIN_PAT); if(m){ events.push({type:'join', nick:m[1].trim(), raw:line}); joinedCount++; continue; }
    m=line.match(LEAVE_PAT); if(m){ events.push({type:'leave', nick:m[1].trim(), raw:line}); leftCount++; continue; }
  }
  return {events, joinedCount, leftCount};
}

/* ===== 실행 ===== */
async function runMain(){
  try{
    txt('err',''); const res=$$('results'); if(res) res.innerHTML='';
    const chatFile=$$('chatFile')?.files?.[0]; if(!chatFile) throw new Error('대화 txt 파일을 선택하세요.');
    const packSel=$$('sheetPackSelect'); if(!packSel || !packSel.value) throw new Error('스프레드시트를 선택하세요.');
    const readSheet=val('readSheetSelect'); if(!readSheet) throw new Error('읽기 시트를 선택하세요.');
    const writeSheet=val('writeSheetSelect'); if(!writeSheet) throw new Error('공유 시트를 선택하세요.');

    const packs=loadPacks(); const pack=packs.find(x=>x.id===packSel.value); if(!pack) throw new Error('연결 정보를 찾을 수 없습니다.');
    const sheetId=pack.sheetId; const readCol=pack.readCol||'C';

    // 1) 카톡 파싱
    const chatText = await readText(chatFile);
    const {events, joinedCount, leftCount} = parseChat(chatText);

    const activeDigitsByName = new Map(); // key: 정규화된 이름 → Set(끝4 or sentinel)
    const nameOnlyJoin = new Set();       // 번호 없이 입장한 정규화 이름
    const NAME_ONLY_SENTINEL = '__NAMEONLY__';
    const ensure=(n)=>{ if(!activeDigitsByName.has(n)) activeDigitsByName.set(n,new Set()); return activeDigitsByName.get(n); };

    for(const ev of events){
      const s=splitNickname(ev.nick);
      if(!s) continue;
      if(ev.type==='join'){
        if(s.digits){ ensure(s.name).add(s.digits); }
        else { nameOnlyJoin.add(s.name); ensure(s.name).add(NAME_ONLY_SENTINEL); }
      }else if(ev.type==='leave'){
        if(s.digits){ ensure(s.name).delete(s.digits); }
        else { const set=ensure(s.name); if(set.size===1 && set.has(NAME_ONLY_SENTINEL)) set.delete(NAME_ONLY_SENTINEL); }
      }
    }

    // 2) 읽기 시트 로드(이름=readCol, 전화끝4=H, 결제상태=I) → 결제완료만
    const namesData = await getRange(sheetId, `${readSheet}!${readCol}${READ_START_ROW}:${readCol}`);
    const phoneData = await getRange(sheetId, `${readSheet}!H${READ_START_ROW}:H`);
    const payData   = await getRange(sheetId, `${readSheet}!I${READ_START_ROW}:I`);

    const allRecords = [];
    const maxLen = Math.max(namesData.values?.length||0, phoneData.values?.length||0, payData.values?.length||0);
    for(let i=0;i<maxLen;i++){
      const rawName = (namesData.values?.[i]?.[0]) ?? '';
      const name = String(rawName).trim();
      if(!name) continue;
      const nameN = normalizeName(name);
      const phone4 = last4Digits((phoneData.values?.[i]?.[0]) ?? '');
      const paid   = isPaid((payData.values?.[i]?.[0]) ?? '');
      allRecords.push({ name, nameN, phone4, paid });
    }
    const paidRecords = allRecords.filter(r => r.paid);

    // 결제완료 집합 내 "정규화 이름" 기준 동명이인 판단
    const countByNameN = new Map();
    paidRecords.forEach(r => countByNameN.set(r.nameN, (countByNameN.get(r.nameN)||0)+1));
    const dupPaidByNameN = new Map();
    countByNameN.forEach((c,n)=> dupPaidByNameN.set(n, c>1));
    const rosterPaidSetN = new Set(paidRecords.map(r=>r.nameN));

    // 3) 리포트(결제완료만)
    const report=[]; const unresolved=[];
    for (const r of paidRecords) {
      const set = activeDigitsByName.get(r.nameN) || new Set();
      const isDup = dupPaidByNameN.get(r.nameN) || false;

      if (isDup) {
        if (r.phone4 && set.has(r.phone4)) {
          report.push([r.name, '입장', `${r.name}/${r.phone4}`, '동명이인(전화일치)']);
        } else {
          if (nameOnlyJoin.has(r.nameN)) {
            unresolved.push([r.name, '동명이인인데 입장로그 번호 없음(결제 완료 집합)']);
          }
          report.push([r.name, '미입장', '', '동명이인/전화불일치 또는 번호없음']);
        }
      } else {
        if (set.size >= 1 || nameOnlyJoin.has(r.nameN)) {
          const onlyDigit=[...set].find(x=>x!==NAME_ONLY_SENTINEL) || '';
          report.push([r.name,'입장', onlyDigit ? `${r.name}/${onlyDigit}` : r.name, onlyDigit?'':'(이름 유일/번호없음)']);
        } else {
          report.push([r.name,'미입장','','']);
        }
      }
    }

    // 3-1) 명단 외(결제완료 집합에 없는 입장자)
    const extraJoined = [];
    [...activeDigitsByName.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nameN,set])=>{
      if(!rosterPaidSetN.has(nameN)){
        const digits=[...set].filter(x=>x!==NAME_ONLY_SENTINEL);
        if(digits.length){ digits.sort().forEach(d => extraJoined.push([`${nameN}/${d}`])); }
        if(set.has(NAME_ONLY_SENTINEL)){ extraJoined.push([`${nameN}(번호없음)`]); }
      }
    });

    // 4) 공유 시트 갱신: D(이름), E(전화) → S
    const writeRange = `${writeSheet}!D${WRITE_START_ROW}:S`;
    const wdata = await getRange(sheetId, writeRange);
    const rows = wdata.values || [];
    const updates = [];

    const writeNameCountsN = new Map();
    for(let i=0;i<rows.length;i++){
      const nm = normalizeName(String(rows[i]?.[0] ?? '').trim());
      if(!nm) continue;
      writeNameCountsN.set(nm, (writeNameCountsN.get(nm)||0)+1);
    }
    const S_INDEX = 15;

    for (let i = 0; i < rows.length; i++) {
      const r = rows[i] || [];
      const nameRaw  = String(r[0] ?? '').trim(); // D
      if (!nameRaw) continue;
      if (WRITE_START_ROW===2 && nameRaw==='이름') continue;
      const nameN = normalizeName(nameRaw);
      const phone = last4Digits(r[1] ?? '');      // E

      // 결제완료 대상(정규화 이름)만 기록
      if (!rosterPaidSetN.has(nameN)) continue;

      const set = activeDigitsByName.get(nameN) || new Set();
      const dupPaid  = !!dupPaidByNameN.get(nameN);                // 결제완료 집합 내 동명이인
      const dupWrite = (writeNameCountsN.get(nameN)||0) > 1;       // 공유시트 내 동명이인(참고)
      const needPhoneToMatch = dupPaid;

      let writeAction = null; // '입장' | '' | null(미확인)
      if (set.size === 0 && !nameOnlyJoin.has(nameN)) {
        writeAction = '';
      } else if (needPhoneToMatch) {
        if (phone) {
          writeAction = set.has(phone) ? '입장' : '';
        } else {
          if (nameOnlyJoin.has(nameN)) {
            unresolved.push([nameRaw,'동명이인 + 입장로그 번호없음(공유시트 기록 보류)']);
            writeAction = null;
          } else {
            writeAction = '';
          }
        }
      } else {
        writeAction = (set.size >= 1 || nameOnlyJoin.has(nameN)) ? '입장' : '';
      }

      if (writeAction !== '입장' && dupWrite && nameOnlyJoin.has(nameN)) {
        unresolved.push([nameRaw,'공유시트 동명이인 발견 + 입장로그 번호없음(기록 보류)']);
        writeAction = null;
      }

      if (writeAction !== null) {
        const rowNumber = WRITE_START_ROW + i;
        const valOut = (writeAction === '입장') ? '입장' : ''; // 미입장은 빈칸
        updates.push({ range: `${writeSheet}!S${rowNumber}`, values: [[valOut]] });
        if (r.length <= S_INDEX) r[S_INDEX] = valOut; else r[S_INDEX] = valOut;
      }
    }

    if (updates.length) await batchUpdateValues(sheetId, updates);

    // 5) UI
    if(res){
      res.innerHTML='';
      const joinedCount = [...activeDigitsByName.values()].reduce((a,s)=>a+[...s].some(x=>x!=='__NAMEONLY__'||s.has('__NAMEONLY__'))?1:0,0); // 대략치
      // 상단 배지
      const pills=$$('pills'); if(pills){ pills.innerHTML='';
        const mk=(t,c)=>{ const s=document.createElement('span'); s.className='pill '+c; s.textContent=t; return s; };
        pills.appendChild(mk(`결제완료 ${paidRecords.length}`, 'ok'));
        pills.appendChild(mk(`입장로그 이름키 ${activeDigitsByName.size}`, 'warn'));
      }
      // 테이블
      const makeTable=(title, headers, rows)=>{
        const wrap=document.createElement('div'); wrap.className='card';
        const h=document.createElement('h3'); h.textContent=title; h.style.margin='0 0 8px'; wrap.appendChild(h);
        const table=document.createElement('table');
        const thead=document.createElement('thead'); const trh=document.createElement('tr');
        headers.forEach(x=>{ const th=document.createElement('th'); th.textContent=x; trh.appendChild(th); }); thead.appendChild(trh); table.appendChild(thead);
        const tbody=document.createElement('tbody'); rows.forEach(r=>{ const tr=document.createElement('tr'); r.forEach(c=>{ const td=document.createElement('td'); td.textContent=(c==null?'':String(c)); tr.appendChild(td); }); tbody.appendChild(tr); }); table.appendChild(tbody);
        wrap.appendChild(table); res.appendChild(wrap);
      };
      makeTable('내 명단 기준 상태(결제 완료 대상)', ['name','status','matched_id','notes'], report);
      makeTable('명단 외 입장자(결제 완료 명단 밖)', ['name/last4 or (번호없음)'], extraJoined);
      makeTable('미확인 목록', ['name','reason'], unresolved);
      makeTable('공유 시트 갱신 결과', ['updated_cells'], updates.map(u=>[u.range+' ← '+u.values[0][0]]));
    }

  }catch(e){ txt('err','오류: '+(e?.message||e)); console.error(e); }
}

/* ===== 데모(간단) ===== */
function runDemo(){
  txt('err',''); const res=$$('results'); if(res) res.innerHTML='';
  const chatText=[
    '2025.08.10 오후 8:01 - 권지혁/3788님이 입장하셨습니다',
    '2025.08.10 오후 8:03 - 홍길동님이 입장하셨습니다',
    '2025.08.10 오후 8:04 - 홍길동-1234님이 입장하셨습니다',
    '2025.08.10 오후 8:07 - 김민정 1122님이 들어왔습니다!'
  ].join('\\n');
  const {events}=parseChat(chatText);
  const active=new Map(); const nameOnly=new Set(); const sentinel='__NAMEONLY__';
  const ensure=(n)=>{ if(!active.has(n)) active.set(n,new Set()); return active.get(n); };
  for(const ev of events){
    const s=splitNickname(ev.nick); if(!s) continue;
    if(ev.type==='join'){ if(s.digits) ensure(s.name).add(s.digits); else { ensure(s.name).add(sentinel); nameOnly.add(s.name); } }
  }
  const rows=[]; active.forEach((set,name)=>{ const d=[...set].find(x=>x!==sentinel)||''; rows.push([name, d?`입장(${d})`:'입장(번호없음)']); });
  const wrap=document.createElement('div'); wrap.className='card'; const h=document.createElement('h3'); h.textContent='데모 결과'; wrap.appendChild(h);
  const t=document.createElement('table'); t.innerHTML='<thead><tr><th>name</th><th>status</th></tr></thead>'; const tb=document.createElement('tbody');
  rows.forEach(r=>{ const tr=document.createElement('tr'); r.forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); }); tb.appendChild(tr); }); t.appendChild(tb); wrap.appendChild(t); res.appendChild(wrap);
}

/* ===== 초기화 ===== */
window.addEventListener('load', ()=>{ if(window.google?.accounts?.oauth2) initAuth(); });
document.addEventListener('DOMContentLoaded', ()=>{
  on('gsLoginBtn','click', requestAccess);
  on('gsLogoutBtn','click', revokeAccess);

  const overlay=$$('adminOverlay'), drawer=$$('adminDrawer');
  const openAdmin=()=>{ if(overlay&&drawer){ show(overlay); show(drawer); renderAdmList(); } };
  const closeAdmin=()=>{ if(overlay&&drawer){ hide(overlay); hide(drawer); } };
  on('settingsBtn','click', openAdmin);
  on('closeAdmin','click', closeAdmin);
  if(overlay) overlay.addEventListener('click', closeAdmin);

  on('admAdd','click', admAdd);
  on('admClearAll','click', ()=>{ if(confirm('모든 연결을 삭제할까요?')){ clearPacks(); renderAdmList(); populatePacks(); } });

  on('sheetPackSelect','change', onPackChanged);
  on('refreshMeta','click', refreshMeta);

  on('runBtn','click', runMain);
  on('demoBtn','click', runDemo);

  // 위임(추가 안전망)
  ['settingsBtn','closeAdmin','admAdd','admClearAll','refreshMeta','runBtn','demoBtn'].forEach(id=>{
    delegateClick(id, ()=>{ const el=$$(id); if(el) el.click(); });
  });

  populatePacks();
});
</script>
</body>
</html>
