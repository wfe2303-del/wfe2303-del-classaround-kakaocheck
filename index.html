<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>클래스어라운드 · 카카오톡 입장자 체크봇 (Sheets API)</title>

  <!-- Google Identity Services (OAuth) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg:#fff; --card:#fff; --surface:#f8fafc; --line:#e5e7eb; --text:#0f172a; --muted:#64748b;
      --accent:#60a5fa; --accent-strong:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:12px; --ctl-h:42px; --gap:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px;position:relative}
    h1{font-size:22px;margin:0 0 8px}
    .sub{color:var(--muted);margin-bottom:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px}
    label{display:block;color:var(--muted);margin-bottom:6px}
    select, textarea, input[type=text], input[type=file]{
      width:100%; background:#fff; color:var(--text); border:1px solid var(--line);
      border-radius:var(--radius); padding:10px 12px; outline:none; height:var(--ctl-h);
    }
    .btn{
      appearance:none; border:1px solid var(--line); background:#fff; color:var(--text);
      padding:10px 14px; border-radius:var(--radius); cursor:pointer; transition:all .15s ease;
      height:var(--ctl-h); display:inline-flex; align-items:center; justify-content:center;
    }
    .btn:hover{border-color:var(--accent-strong);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
    .btn.acc{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.acc:hover{background:var(--accent-strong);border-color:var(--accent-strong)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hint{color:#64748b;font-size:12px}
    .err{color:#ef4444;font-family:ui-monospace,monospace}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);background:#fff}
    .pill.ok{border-color:rgba(34,197,94,.25);color:var(--ok)}
    .pill.warn{border-color:rgba(245,158,11,.25);color:var(--warn)}
    .pill.bad{border-color:rgba(239,68,68,.25);color:var(--bad)}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);overflow:auto;background:#fff;border-radius:12px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{color:#0f172a;font-weight:600;background:#f1f5f9;position:sticky;top:0}

    .controls-grid{display:grid;gap:var(--gap);align-items:end}
    @media(min-width:1000px){ .controls-grid{grid-template-columns:1.2fr 1.1fr 1fr} }
    @media(min-width:640px) and (max-width:999px){ .controls-grid{grid-template-columns:1fr 1fr} }

    .gear-btn{position:fixed;top:16px;right:16px;z-index:50;background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;cursor:pointer}
    .gear-btn:hover{border-color:var(--accent-strong);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
    .admin-overlay{position:fixed;inset:0;background:rgba(15,23,42,.28);backdrop-filter:saturate(140%) blur(2px);display:none;z-index:60}
    .admin-drawer{position:fixed;top:0;right:0;height:100%;width:520px;max-width:92vw;background:#fff;border-left:1px solid var(--line);box-shadow:-8px 0 24px rgba(0,0,0,.08);padding:16px 16px 24px;display:none;flex-direction:column;gap:12px;z-index:70}
    .admin-head{display:flex;align-items:center;justify-content:space-between}
    .x-btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer}
    .x-btn:hover{border-color:#94a3b8}
  </style>
</head>
<body>
  <!-- Settings -->
  <button id="settingsBtn" class="gear-btn" title="설정" type="button" aria-label="관리자 설정 열기">⚙</button>

  <div class="wrap">
    <h1>클래스어라운드 카카오톡 입장자 체크봇</h1>
    <div class="sub">
      1) <b>Google 로그인</b> → 2) <b>관리자(⚙)</b>에서 <b>스프레드시트 링크 + 읽을 열</b> 등록 → 3) 메인에서 <b>읽기 시트/공유 시트</b> 선택 후 실행.<br>
      공유 시트는 <b>D=이름</b>, <b>E=전화</b>, <b>S=상태</b> 기준이며, 동명이인 시 전화 <b>끝 4자리</b>로 재매칭합니다.
    </div>

    <!-- 로그인/상태 -->
    <div class="card">
      <div class="row">
        <button id="gsLoginBtn" class="btn acc" type="button">Google 로그인</button>
        <button id="gsLogoutBtn" class="btn" type="button">로그아웃</button>
        <span id="authState" class="hint">미로그인</span>
      </div>
      <div id="authErr" class="err" style="margin-top:6px"></div>
    </div>

    <!-- 상단 컨트롤 -->
    <div class="card">
      <div class="controls-grid">
        <div>
          <label>카카오톡 대화 <span class="hint">.txt</span></label>
          <input id="chatFile" type="file" accept=".txt" />
          <div class="hint">예: “… 권지혁/3788님이 입장하셨습니다.”</div>
        </div>
        <div>
          <label>로스터 소스 (스프레드시트)</label>
          <div class="row">
            <select id="sheetPackSelect" style="min-width:220px"></select>
            <button id="refreshMeta" class="btn" type="button">시트 목록 새로고침</button>
          </div>
          <div class="hint">읽기 시작 행: <b id="readStartHint">2</b> · 읽을 열: <b id="readColHint">-</b> · 공유 시작 행: <b id="writeStartHint">2</b></div>
        </div>
        <div>
          <label>읽기 시트 / 공유 시트</label>
          <div class="row">
            <select id="readSheetSelect" style="min-width:180px"></select>
            <select id="writeSheetSelect" style="min-width:180px"></select>
          </div>
          <div class="hint">공유 시트는 <b>D(이름)→E(전화끝4)</b> 순으로 매칭, 결과는 <b>S</b>에 기록(미입장은 빈칸, 미확인은 테이블로).</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="runBtn" class="btn acc" type="button">실행</button>
        <button id="demoBtn" class="btn" type="button">데모</button>
        <span id="pills" class="row"></span>
      </div>
      <div id="err" class="err" style="margin-top:8px"></div>
    </div>

    <div id="results" style="display:grid;gap:16px"></div>
  </div>

  <!-- 관리자 드로어 -->
  <div id="adminOverlay" class="admin-overlay"></div>
  <aside id="adminDrawer" class="admin-drawer">
    <div class="admin-head">
      <h3 style="margin:0">관리자 설정</h3>
      <button id="closeAdmin" class="x-btn" type="button">닫기</button>
    </div>

    <div class="card" style="margin:0">
      <h4 style="margin:0 0 8px">스프레드시트 연결 추가</h4>
      <label>표시 이름(선택)</label>
      <input id="admLabel" type="text" placeholder="예: 4기 운영 시트" />
      <label style="margin-top:10px">스프레드시트 링크(URL)</label>
      <input id="admUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/..." />
      <label style="margin-top:10px">읽을 열(A~) <span class="hint">명단이 들어있는 열(예: C)</span></label>
      <input id="admReadCol" type="text" value="C" />
      <div class="row" style="margin-top:10px">
        <button id="admAdd" class="btn" type="button">연결 추가</button>
        <button id="admClearAll" class="btn" type="button">전체 삭제</button>
      </div>
      <div id="admErr" class="err" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 8px">등록된 스프레드시트</h4>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr><th style="background:#f1f5f9">라벨</th><th style="background:#f1f5f9">시트수</th><th style="background:#f1f5f9">읽을 열</th><th style="background:#f1f5f9">작업</th></tr></thead>
        <tbody id="admList"><tr><td colspan="4" style="color:#64748b">없음</td></tr></tbody>
      </table>
      <div class="hint" id="admMeta" style="margin-top:6px"></div>
    </div>
  </aside>

<script>
/* =====================[ 상수: 시작 행 ]===================== */
const READ_START_ROW  = 2; // 읽기 시트(명단) 시작 행
const WRITE_START_ROW = 2; // 공유 시트(상태) 시작 행

/* =====================[ 공통 / OAuth ]===================== */
const CLIENT_ID = "18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com"; // ★ 교체하세요

const $$ = (id)=>document.getElementById(id);
function setErr(msg){ $$("err").textContent = msg||""; }
function setAdmErr(msg){ $$("admErr").textContent = msg||""; }
function setAuthErr(msg){ $$("authErr").textContent = msg||""; }
function setPills({joined,left,exceptions}){
  const el=$$("pills"); el.innerHTML='';
  const pill=(txt,cls)=>{const s=document.createElement('span'); s.className='pill '+cls; s.textContent=txt; return s;};
  el.appendChild(pill(`입장 ${joined}`,'ok'));
  el.appendChild(pill(`퇴장 ${left}`,'bad'));
  el.appendChild(pill(`예외 ${exceptions}`,'warn'));
}
function showTable(title, headers, rows){
  const wrap=document.createElement('div'); wrap.className='card';
  const h=document.createElement('h3'); h.textContent=title; h.style.margin='0 0 8px'; wrap.appendChild(h);
  const table=document.createElement('table');
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  headers.forEach(x=>{ const th=document.createElement('th'); th.textContent=x; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody=document.createElement('tbody');
  rows.forEach(r=>{ const tr=document.createElement('tr'); r.forEach(c=>{ const td=document.createElement('td'); td.textContent=(c==null?'':String(c)); tr.appendChild(td); }); tbody.appendChild(tr); });
  table.appendChild(tbody); wrap.appendChild(table);
  $$("results").appendChild(wrap);
}

function extractSheetId(urlOrId){
  if(!urlOrId) return '';
  const m = String(urlOrId).match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  return m ? m[1] : urlOrId.trim();
}
function sanitizeColumn(input){ if(!input) return null; let s=String(input).trim().toUpperCase().replace(/\s|열/g,''); if(!s) return null; if(/^\d+$/.test(s)){let n=parseInt(s,10), out=''; while(n>0){ let r=(n-1)%26; out=String.fromCharCode(65+r)+out; n=Math.floor((n-1)/26);} return out;} if(/^[A-Z]+$/.test(s)) return s; return null; }
function last4Digits(s){ const d=String(s||'').replace(/\D/g,''); return d.slice(-4); }

/* ===== OAuth (GIS) ===== */
let accessToken=null, tokenClient=null;
function initAuth(){
  if(!window.google?.accounts?.oauth2){ setAuthErr('GIS 로드 실패(네트워크/도메인 확인)'); return; }
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/spreadsheets',
    prompt: '',
    callback: (res)=>{ accessToken = res.access_token; $$("authState").textContent='로그인 완료'; setAuthErr(''); },
    error_callback: (err)=>{ setAuthErr('OAuth 오류: ' + (err?.error || err?.type || JSON.stringify(err))); console.error('OAuth error:', err); }
  });
}
function requestAccess(){ if(!tokenClient){ setAuthErr('OAuth 초기화 실패'); return; } tokenClient.requestAccessToken({prompt:'consent'}); }
function revokeAccess(){ if(accessToken){ google.accounts.oauth2.revoke(accessToken, ()=>{ accessToken=null; $$("authState").textContent='미로그인'; }); } }
function requireAuth(){ if(!accessToken) throw new Error('먼저 Google 로그인하세요.'); }

/* ===== Sheets REST ===== */
async function gFetch(url, init){
  requireAuth();
  const res = await fetch(url, { ...(init||{}), headers: { ...(init&&init.headers||{}), Authorization:'Bearer '+accessToken, 'Content-Type':'application/json' }});
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}
async function listSheets(spreadsheetId){
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets(properties(title))`;
  const data = await gFetch(url);
  return (data.sheets||[]).map(s=>s.properties.title);
}
async function getRange(spreadsheetId, rangeA1){
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(rangeA1)}`;
  return await gFetch(url);
}
async function batchUpdateValues(spreadsheetId, dataRanges){
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values:batchUpdate`;
  return await gFetch(url, { method:'POST', body: JSON.stringify({ valueInputOption:'USER_ENTERED', data: dataRanges })});
}

/* =====================[ 관리자: 스프레드시트 등록 ]===================== */
const PACKS_KEY='ca_gsapi_sources_v4';
const loadPacks=()=>{ try{return JSON.parse(localStorage.getItem(PACKS_KEY)||'[]');}catch(e){return [];} };
const savePacks=(ps)=> localStorage.setItem(PACKS_KEY, JSON.stringify(ps));
const addPack=(p)=>{ const a=loadPacks(); a.push(p); savePacks(a); };
const removePack=(id)=> savePacks(loadPacks().filter(p=>p.id!==id));
const clearPacks=()=> localStorage.removeItem(PACKS_KEY);

async function admAdd(){
  try{
    setAdmErr('');
    const label = ($$("admLabel").value.trim() || "스프레드시트");
    const sheetId = extractSheetId($$("admUrl").value.trim());
    const readCol = sanitizeColumn($$("admReadCol").value) || 'C';
    if(!sheetId) throw new Error('스프레드시트 링크/ID를 입력하세요.');
    const titles = await listSheets(sheetId); // OAuth 필요
    const pack = { id:`${Date.now()}_${Math.random().toString(36).slice(2,7)}`, label, sheetId, readCol, sheets: titles };
    addPack(pack);
    $$("admLabel").value=$$("admUrl").value=''; $$("admReadCol").value='C';
    renderAdmList(); populatePacks(); alert('연결 완료! 메인에서 선택하세요.');
  }catch(e){ setAdmErr(e.message); }
}
function renderAdmList(){
  const list=loadPacks(); const tb=$$("admList"); tb.innerHTML='';
  if(!list.length){ tb.innerHTML='<tr><td colspan="4" style="color:#64748b">없음</td></tr>'; $$("admMeta").textContent=''; return; }
  list.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.label}</td><td>${p.sheets?.length||0}</td><td>${p.readCol}</td><td><button class="btn" data-del="${p.id}" type="button">삭제</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-del]').forEach(b=> b.onclick=()=>{ removePack(b.getAttribute('data-del')); renderAdmList(); populatePacks(); });
  $$("admMeta").textContent = `총 ${list.length}개 연결 · ${new Date().toLocaleString()}`;
}

/* =====================[ 메인: 소스/시트 선택 ]===================== */
function populatePacks(){
  const packs=loadPacks(); const sel=$$("sheetPackSelect"); sel.innerHTML='';
  if(!packs.length){
    sel.appendChild(new Option('(관리자에서 스프레드시트 연결)',''));
    $$("readColHint").textContent='-'; $$("readStartHint").textContent=READ_START_ROW; $$("writeStartHint").textContent=WRITE_START_ROW;
    $$("readSheetSelect").innerHTML=''; $$("writeSheetSelect").innerHTML=''; return;
  }
  sel.appendChild(new Option('스프레드시트 선택',''));
  packs.forEach(p=> sel.appendChild(new Option(p.label, p.id)));
  const prev=sessionStorage.getItem('ca_prev_pack'); if(prev){ const o=[...sel.options].find(x=>x.value===prev); if(o) o.selected=true; }
  onPackChanged();
}
async function refreshMeta(){
  try{
    const id=$$("sheetPackSelect").value; if(!id) return;
    const packs=loadPacks(); const idx=packs.findIndex(p=>p.id===id); if(idx<0) return;
    const titles = await listSheets(packs[idx].sheetId);
    packs[idx].sheets = titles; savePacks(packs); onPackChanged();
  }catch(e){ setErr('시트 목록 갱신 실패: '+e.message); }
}
function onPackChanged(){
  const id=$$("sheetPackSelect").value; sessionStorage.setItem('ca_prev_pack', id||'');
  const packs=loadPacks(); const p=packs.find(x=>x.id===id);
  const readSel=$$("readSheetSelect"), writeSel=$$("writeSheetSelect");
  readSel.innerHTML=''; writeSel.innerHTML='';
  if(!p){ $$("readColHint").textContent='-'; $$("readStartHint").textContent=READ_START_ROW; $$("writeStartHint").textContent=WRITE_START_ROW; return; }
  $$("readColHint").textContent=p.readCol; $$("readStartHint").textContent=READ_START_ROW; $$("writeStartHint").textContent=WRITE_START_ROW;
  readSel.appendChild(new Option('읽기 시트 선택','')); writeSel.appendChild(new Option('공유 시트 선택',''));
  (p.sheets||[]).forEach(t=>{ readSel.appendChild(new Option(t,t)); writeSel.appendChild(new Option(t,t)); });
}

/* =====================[ 카톡 로그 파싱 ]===================== */
const JOIN_PAT = /(.*?)님이\s*(입장하셨습니다|들어왔습니다|입장했습니다|들어오셨습니다)\./;
const LEAVE_PAT = /(.*?)님이\s*(퇴장하셨습니다|나갔습니다|퇴장했습니다|나가셨습니다)\./;
const NICK_PATTERN = /^\s*([A-Za-z0-9가-힣·\s]+?)\s*[\/-]?\s*(\d{4})\s*$/;
const NAME_ONLY = /^\s*([A-Za-z0-9가-힣·\s]+?)\s*$/;

async function readText(file){ return await file.text(); }
function parseChat(text){
  const lines=text.split(/\r?\n/);
  const events=[]; let joinedCount=0,leftCount=0;
  for(const raw of lines){
    const line=raw.trim(); if(!line) continue;
    let m=line.match(JOIN_PAT); if(m){ events.push({type:'join', nick:m[1].trim(), raw:line}); joinedCount++; continue; }
    m=line.match(LEAVE_PAT); if(m){ events.push({type:'leave', nick:m[1].trim(), raw:line}); leftCount++; continue; }
  }
  return {events, joinedCount, leftCount};
}
function splitNickname(nick){
  const m=nick.match(NICK_PATTERN);
  if(m) return {name:m[1].trim(), digits:m[2]};
  const n=nick.match(NAME_ONLY);
  if(n) return {name:n[1].trim(), digits:null}; // 이름만
  return null;
}

/* =====================[ 실행: 읽기 → 판정 → 공유시트 쓰기 ]===================== */
async function runMain(){
  try{
    setErr(''); $$("results").innerHTML='';
    const chatFile=$$("chatFile").files[0]; if(!chatFile) throw new Error('대화 txt 파일을 선택하세요.');
    const packId=$$("sheetPackSelect").value; if(!packId) throw new Error('스프레드시트를 선택하세요.');
    const readSheet=$$("readSheetSelect").value; if(!readSheet) throw new Error('읽기 시트를 선택하세요.');
    const writeSheet=$$("writeSheetSelect").value; if(!writeSheet) throw new Error('공유 시트를 선택하세요.');

    const packs=loadPacks(); const pack=packs.find(x=>x.id===packId); if(!pack) throw new Error('연결 정보를 찾을 수 없습니다.');
    const sheetId=pack.sheetId; const readCol=pack.readCol||'C';

    /* 1) 카톡 파싱 → 현재 입장자 계산 */
    const chatText = await readText(chatFile);
    const {events, joinedCount, leftCount} = parseChat(chatText);

    const activeDigitsByName = new Map(); // name -> Set(4자리)
    const nameOnlyJoin = new Set();       // 번호 없이 이름만 입장 기록된 이름들
    const exceptionsJoin=[];              // 디버그용(패턴 미일치)

    const ensure=(name)=>{ if(!activeDigitsByName.has(name)) activeDigitsByName.set(name,new Set()); return activeDigitsByName.get(name); };

    for(const ev of events){
      const s=splitNickname(ev.nick);
      if(!s){ exceptionsJoin.push(ev.nick); continue; }
      if(ev.type==='join'){
        if(s.digits){ ensure(s.name).add(s.digits); }
        else { nameOnlyJoin.add(s.name); exceptionsJoin.push(ev.nick); } // 번호 없는 입장도 예외 목록에 기록
      }else if(ev.type==='leave'){
        if(s.digits){ ensure(s.name).delete(s.digits); }
        else {
          // 이름만 퇴장: 현재 하나만 남아있으면 제거(보수적 처리)
          if(activeDigitsByName.has(s.name)){
            const set=activeDigitsByName.get(s.name);
            if(set.size===1){ set.delete([...set][0]); }
          }
        }
      }
    }

    /* 2) 읽기 시트에서 명단 + 동명이인/전화 메타 가져오기
          - 이름: readCol
          - 동명이인 플래그: G열(빈칸 아니면 true로 간주)
          - 전화 끝4: H열
    */
    const namesData = await getRange(sheetId, `${readSheet}!${readCol}${READ_START_ROW}:${readCol}`);
    const dupData   = await getRange(sheetId, `${readSheet}!G${READ_START_ROW}:G`);
    const phoneData = await getRange(sheetId, `${readSheet}!H${READ_START_ROW}:H`);

    const rosterRecords = [];
    const maxLen = Math.max(namesData.values?.length||0, dupData.values?.length||0, phoneData.values?.length||0);
    for(let i=0;i<maxLen;i++){
      const name = String((namesData.values?.[i]?.[0]) ?? '').trim();
      if(!name) continue;
      const dupFlagRaw = String((dupData.values?.[i]?.[0]) ?? '').trim();
      const phone4 = last4Digits((phoneData.values?.[i]?.[0]) ?? '');
      rosterRecords.push({ name, dup: !!dupFlagRaw, phone4 });
    }
    const rosterSet = new Set(rosterRecords.map(r=>r.name));
    // 이름→(dup, rosterPhones(set)) 맵
    const dupByName = new Map();
    const rosterPhonesByName = new Map();
    rosterRecords.forEach(r=>{
      dupByName.set(r.name, dupByName.get(r.name) || r.dup);
      if(r.phone4){
        if(!rosterPhonesByName.has(r.name)) rosterPhonesByName.set(r.name, new Set());
        rosterPhonesByName.get(r.name).add(r.phone4);
      }
    });

    /* 3) 보고서(명단 기준) + 미확인 목록 준비
          규칙:
          - 동명이인(dup=true): roster의 phone4가 있고, activeDigits(name)에 그 phone4가 있으면 '입장'
                               phone4 없거나, 로그에 번호가 없으면 → '미확인' 후보
          - 동명이인 아님: activeDigits(name).size>=1 또는 nameOnlyJoin 포함 → '입장'
    */
    const report=[]; const unresolved=[]; // 미확인 목록
    for(const r of rosterRecords){
      const set = activeDigitsByName.get(r.name) || new Set();
      if(r.dup){
        if(r.phone4 && set.has(r.phone4)){
          report.push([r.name,'입장',`${r.name}/${r.phone4}`,'동명이인(전화일치)']);
        }else{
          if(nameOnlyJoin.has(r.name)){
            unresolved.push([r.name,'동명이인인데 로그에 번호 없음(읽기시트 기준)']);
          }
          report.push([r.name,'미입장','','동명이인/전화불일치 또는 번호없음']);
        }
      }else{
        if(set.size>=1 || nameOnlyJoin.has(r.name)){
          // 번호 없이도 고유 이름이면 입장 처리
          const only = set.size===1 ? [...set][0] : '';
          report.push([r.name,'입장', only ? `${r.name}/${only}` : r.name, only?'':'(이름 유일)']);
        }else{
          report.push([r.name,'미입장','','']);
        }
      }
    }

    /* 3-1) 예외/명단 외 입장자 */
    const extraJoined = [];
    // digits 기반
    [...activeDigitsByName.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([name,set])=>{
      if(!rosterSet.has(name)) [...set].sort().forEach(d => extraJoined.push([`${name}/${d}`]));
    });
    // 이름만 입장(번호없음)인데 명단 외
    nameOnlyJoin.forEach(name=>{ if(!rosterSet.has(name)) extraJoined.push([`${name}(번호없음)`]); });

    const exRows = exceptionsJoin.map(e => [e]);

    /* 4) 공유 시트 D(이름), E(전화) 읽어 S 갱신 (동명이인 판정: D→E끝4) 
          추가 규칙:
          - 공유시트 내 '같은 이름'이 2행 이상이면(동명이인 발견) 전화 없는 행은 '미확인'으로 분류(로그에 번호가 없으면 특히)
          - '미확인'은 S를 건드리지 않음(테이블에만 기록)
          - '미입장'은 S를 빈칸으로 기록
    */
    const writeRange = `${writeSheet}!D${WRITE_START_ROW}:S`; // D..S
    const wdata = await getRange(sheetId, writeRange);
    const rows = wdata.values || [];
    const updates = [];
    const writeNameCounts = new Map();   // 공유시트 내 동명이인 체크용
    const writeNamePhones = new Map();   // name -> Set(전화4)
    for(let i=0;i<rows.length;i++){
      const r = rows[i] || [];
      const name = String(r[0] ?? '').trim();
      const phone = last4Digits(r[1] ?? '');
      if(!name) continue;
      writeNameCounts.set(name, (writeNameCounts.get(name)||0)+1);
      if(phone){
        if(!writeNamePhones.has(name)) writeNamePhones.set(name, new Set());
        writeNamePhones.get(name).add(phone);
      }
    }
    const S_INDEX = 15; // D..S 범위에서 S의 인덱스(D=0 → S=15)

    for (let i = 0; i < rows.length; i++) {
      const r = rows[i] || [];
      const name = String(r[0] ?? '').trim();     // D
      const phone = last4Digits(r[1] ?? '');      // E
      if (!name) continue;
      if (WRITE_START_ROW===2 && name==='이름') continue; // 헤더

      // 명단에 없는 이름이면 스킵(원하면 삭제)
      if (!rosterSet.has(name)) continue;

      const set = activeDigitsByName.get(name) || new Set();
      const dupRoster = !!dupByName.get(name);          // 읽기 시트 기준 동명이인
      const dupWrite  = (writeNameCounts.get(name)||0) > 1; // 공유 시트 기준 동명이인
      const needPhoneToMatch = dupRoster || dupWrite;   // 어느 한쪽에서라도 동명이인이면 전화필요
      let writeAction = null; // '입장' | ''(미입장→비우기) | null(미확인)

      if (set.size === 0 && !nameOnlyJoin.has(name)) {
        // 입장 근거 없음 → 미입장(비우기)
        writeAction = '';
      } else if (needPhoneToMatch) {
        if (phone) {
          // 전화가 있으면 번호 일치 여부로 판단
          writeAction = set.has(phone) ? '입장' : '';
        } else {
          // 전화 없음 → 미확인 규칙
          // (a) 읽기시트 동명이인인데 로그에 번호 없음
          if (dupRoster && nameOnlyJoin.has(name)) {
            unresolved.push([name,'동명이인 + 입장로그 번호없음(공유시트 기록 보류)']);
            writeAction = null;
          }
          // (b) 공유시트에서 동명이인 새로 발견 + 로그에 번호 없음
          else if (dupWrite && nameOnlyJoin.has(name)) {
            unresolved.push([name,'공유시트 동명이인 발견 + 입장로그 번호없음(기록 보류)']);
            writeAction = null;
          } else {
            // 번호 없이도 set이 1개뿐이고, 읽기/공유 둘 다 동명이인 아닌 케이스만 입장 가능하지만
            // 여긴 needPhoneToMatch=true이므로 기록 보류/미입장 중 택1
            writeAction = ''; // 보수적으로 비움
          }
        }
      } else {
        // 동명이인 아님 → 이름만으로 판정
        if (set.size >= 1 || nameOnlyJoin.has(name)) writeAction = '입장';
        else writeAction = '';
      }

      if (writeAction !== null) {
        const rowNumber = WRITE_START_ROW + i; // 실제 시트 행 번호
        const val = (writeAction === '입장') ? '입장' : ''; // 미입장은 빈칸
        updates.push({ range: `${writeSheet}!S${rowNumber}`, values: [[val]] });
        if (r.length <= S_INDEX) r[S_INDEX] = val; else r[S_INDEX] = val;
      }
    }

    if (updates.length) await batchUpdateValues(sheetId, updates);

    /* 5) UI 렌더: 명단 → 예외/명단외 → 미확인 → 갱신결과 */
    $$("results").innerHTML='';
    setPills({joined:joinedCount,left:leftCount,exceptions:exceptionsJoin.length});
    showTable('내 명단 기준 상태', ['name','status','matched_id','notes'], report);
    showTable('예외 입장자 (패턴/번호 미포함)', ['raw_nickname'], exRows);
    showTable('명단 외 입장자', ['name/last4 or (번호없음)'], extraJoined);
    showTable('미확인 목록', ['name','reason'], unresolved);
    showTable('공유 시트 갱신 결과', ['updated_cells'], updates.map(u=>[u.range+' ← '+u.values[0][0]]));

  }catch(e){ setErr('오류: '+e.message); console.error(e); }
}

/* =====================[ 데모 ]===================== */
function runDemo(){
  setErr(''); $$("results").innerHTML='';
  const roster=['권지혁','김민정','홍길동','영희'];
  const chatText=[
    '2025.08.10 오후 8:01 - 권지혁/3788님이 입장하셨습니다.',
    '2025.08.10 오후 8:02 - 김민정 1122님이 들어왔습니다.',
    '2025.08.10 오후 8:03 - 홍길동/9999님이 입장하셨습니다.',
    '2025.08.10 오후 8:04 - 홍길동 1234님이 입장하셨습니다.',
    '2025.08.10 오후 8:05 - 권지혁님이 입장하셨습니다.', // 번호없음(미확인 후보)
    '2025.08.10 오후 8:06 - 영희님이 나갔습니다.',
    '2025.08.10 오후 8:07 - 민수님이 입장하셨습니다.'     // 명단 외
  ].join('\n');

  const {events, joinedCount, leftCount}=parseChat(chatText);
  const activeDigitsByName=new Map(); const nameOnlyJoin=new Set(); const exceptionsJoin=[];
  const ensure=(n)=>{ if(!activeDigitsByName.has(n)) activeDigitsByName.set(n,new Set()); return activeDigitsByName.get(n); };
  for(const ev of events){
    const s=splitNickname(ev.nick);
    if(!s){ exceptionsJoin.push(ev.nick); continue; }
    if(ev.type==='join'){ if(s.digits) ensure(s.name).add(s.digits); else { nameOnlyJoin.add(s.name); exceptionsJoin.push(ev.nick); } }
    else if(ev.type==='leave'){ if(s.digits) ensure(s.name).delete(s.digits); }
  }
  const report=[]; roster.forEach(name=>{
    const set=activeDigitsByName.get(name)||new Set();
    if(set.size===0 && !nameOnlyJoin.has(name)) report.push([name,'미입장','','']);
    else report.push([name,'입장', set.size===1?`${name}/${[...set][0]}`:nameOnlyJoin.has(name)?'(이름유일)': '', '']);
  });
  const rosterSet=new Set(roster);
  const extraJoined=[]; [...activeDigitsByName.entries()].forEach(([name,set])=>{ if(!rosterSet.has(name)) [...set].forEach(d=>extraJoined.push([`${name}/${d}`])); });
  nameOnlyJoin.forEach(name=>{ if(!rosterSet.has(name)) extraJoined.push([`${name}(번호없음)`]); });
  const exRows=exceptionsJoin.map(e=>[e]);

  setPills({joined:joinedCount,left:leftCount,exceptions:exceptionsJoin.length});
  showTable('데모 결과 - 내 명단 기준 상태', ['name','status','matched_id','notes'], report);
  showTable('데모 결과 - 예외 입장자', ['raw_nickname'], exRows);
  showTable('데모 결과 - 명단 외 입장자', ['name/last4 or (번호없음)'], extraJoined);
}

/* =====================[ 이벤트 바인딩 ]===================== */
window.addEventListener('load', ()=>{ if(window.google?.accounts?.oauth2) initAuth(); });
window.addEventListener('DOMContentLoaded', ()=>{
  $$("gsLoginBtn").onclick = requestAccess;
  $$("gsLogoutBtn").onclick = revokeAccess;

  $$("settingsBtn").onclick = ()=>{ $$("adminOverlay").style.display='block'; $$("adminDrawer").style.display='flex'; renderAdmList(); };
  $$("closeAdmin").onclick = $$("adminOverlay").onclick = ()=>{ $$("adminOverlay").style.display='none'; $$("adminDrawer").style.display='none'; };

  $$("admAdd").onclick = admAdd;
  $$("admClearAll").onclick = ()=>{ if(confirm('모든 연결을 삭제할까요?')){ clearPacks(); renderAdmList(); populatePacks(); } };

  $$("sheetPackSelect").onchange = onPackChanged;
  $$("refreshMeta").onclick = refreshMeta;

  $$("runBtn").onclick = runMain;
  $$("demoBtn").onclick = runDemo;

  populatePacks();
});
</script>
</body>
</html>
